<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Made by Phaser</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    //JP be4 changes
    game.load.image('sky', 'assets/sky.png');
    game.load.image('wall', 'assets/wall.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

    //JP changed
    game.load.image('invader', 'assets/invader.png');
    game.load.image('starfield', 'assets/starfield.png');

    //game.load.image('bullet', 'assets/bullet.png');
    game.load.image('ground', 'assets/platform.png');
}

var player;
var platforms;
var cursors;
var mouseclick;

var stars;
var starTime = 0;

var score = 0;
var scoreText;

//JP chaged
var starfield;

var invaders;
var invaderTime = 0;

var choiceText;
var choice;
//for timer
var counterText;
var delaycounter = 0;
var delaycounterText;

//for fire
var fireButton;
var firedButton;

var counterTime = 0;
var start;

var restartText;

//    restartText.anchor.setTo(0.5, 0.5); //remember to set anchor for some vars
function create() {
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    //  The scrolling starfield background
    starfield = game.add.tileSprite(0, 0, 800, 600, 'starfield');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the ground.
    var wall = platforms.create(-50, 0, 'wall');
    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    wall.scale.setTo(2, 2);
    //  This stops it from falling away when you jump on it
    wall.body.immovable = true;

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 120, 'dude');
    //  We need to enable physics on the player
    game.physics.arcade.enable(player);
    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 300;
    player.body.collideWorldBounds = true;
    //  Our two animations, walking left and right.
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);
    //  The text
    scoreText = game.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#ffffff' });

    counterText = game.add.text(16, 48, 'Counter: 0', { fontSize: '32px', fill: '#ffffff' });

    delaycounterText = game.add.text(16, 80, 'Choice: 0', { fontSize: '32px', fill: '#ffffff' });

    restartText = game.add.text(game.world.centerX , game.world.centerY,'123 ', { font: '84px Arial', fill: '#ffffff' });
    restartText.anchor.setTo(0.5, 0.5);
    restartText.visible = false;
    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
    //mouseclick = game.input.onTap.add(tapJump, this);
    //enemy
    fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
    firedButton = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);

    //  Our star group
    stars = game.add.group();
    stars.enableBody = true;
    stars.physicsBodyType = Phaser.Physics.ARCADE;
    stars.createMultiple(30, 'star');
    stars.setAll('anchor.x', 0.5);
    stars.setAll('anchor.y', 1);

    invaders = game.add.group();
    invaders.enableBody = true;
    invaders.physicsBodyType = Phaser.Physics.ARCADE;
    invaders.createMultiple(30, 'invader');
    invaders.setAll('anchor.x', 0.5);
    invaders.setAll('anchor.y', 1);
    // player.setAll('checkWorldBounds', true);
}


function collectStars (player, stars) {
    // Removes the star from the screen
    stars.kill();
    //  Add and update the score
    score += 10;
    //updating score
    scoreText.text = 'Score: ' + score;
    //for restart
    if (score == 10){
        invaders.callAll('kill');
        restartText.text = " You Won, \n Click to restart";
        restartText.visible = true;
        //kill all the invaders when winning
        //the "click to restart"
        game.input.onTap.addOnce(restart,this);
    }
}

function hitinvader (player, invaders) {
    // Removes the star from the screen
    invaders.kill();
    //  Add and update the score
    // score -= 1;
    // scoreText.text = 'Score: ' + score;
        //When the player dies
        //player.kill();
        stars.callAll('kill');

        restartText.text=" GAME OVER \n Click to restart";
        restartText.visible = true;

        //the "click to restart" handler
        game.input.onTap.addOnce(restart,this);
}

function restart () {
    //hide the restart text
    restartText.visible = false;
}

function resetStar (star, platforms) {
    //  Called if the star hit the platform (left)
    star.kill();
}

function resetInvader (invader, platforms) {
    //  Called if the invader hit the platform (left)
    invader.kill();
}

//let the invader go functions
function fireInvader(){
        if (game.time.now > invaderTime){
        //  Grab the first invader we can from the pool
        invader = invaders.getFirstExists(false);
        if (invader){
            //  And fire it
            invader.reset(game.world.width+50, player.y+25);
            invader.body.velocity.x = -400;
            //in case of firing too many at once
            invaderTime = game.time.now + 500;
        }
    }
}

function fireStar(){
        if (game.time.now > starTime){
        //  Grab the first star we can from the pool
        star = stars.getFirstExists(false);

        if (star){
            //  And fire it
            star.reset(game.world.width+50, player.y+25);
            star.body.velocity.x = -400;
            //in case of firing too many at once
            starTime = game.time.now + 500;
        }
    }
}

function update() {
    //choice randoms between 1~5
    if (game.time.now > counterTime){
        choice = Math.floor((Math.random() * 5) + 1); 
        //things comes our every 0.5 sec
        counterTime = game.time.now + 500;
    }

    if (game.input.activePointer.isDown  && player.body.blocked.down && restartText.visible == false){
        player.body.velocity.y = -250;
    }

    if (fireButton.isDown  && player.body.blocked.down ){
        player.body.velocity.y = -250;
    }
    //  Scroll the background
    starfield.tilePosition.x -= 2;

    //JP changed player running right always
    player.animations.play('right');
    
    //JP allow player go down faster
    if (cursors.down.isDown && !(player.body.touching.down))
    {
        player.body.velocity.y += 5;
    }
    
    //  Checks to see if the player overlaps with stars, if he does call the collectStar function
    game.physics.arcade.overlap(player, stars, collectStars, null, this);
    //  Checks to see if the player overlaps with invader, if he does call the hitinvader function
    game.physics.arcade.overlap(player, invaders, hitinvader, null, this);

    //if star hits platform, kill it
    game.physics.arcade.overlap(stars, platforms, resetStar, null, this);

    game.physics.arcade.overlap(invaders, platforms, resetInvader, null, this);

    if ((choice == 1) || fireButton.isDown){
        if (restartText.visible == false){
            fireInvader();
        }
    }
    if ((choice == 2) || firedButton.isDown){
        if (restartText.visible == false){
            fireStar();
        }
    }

    delaycounterText.text = 'Choice: ' + choice;
}

</script>

</body>
</html>