<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Made by Phaser</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(667, 345, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    //JP be4 changes
    game.load.image('startBG', 'assets/pics/startBG1.png');
    game.load.image('overBG', 'assets/pics/overBG1.png');
    game.load.image('winBG', 'assets/pics/winBG1.png');
    game.load.image('wall', 'assets/wall.png');
    game.load.image('flower', 'assets/pics/flower1.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

    //JP changed
    game.load.image('invader', 'assets/pics/invader1.png');
    game.load.image('gameBG1', 'assets/pics/gameBG1.png');

    //game.load.image('bullet', 'assets/bullet.png');
    game.load.image('ground', 'assets/platform.png');
}

var player;
var platforms;
var cursors;
var mouseclick;

var stars;
var starTime = 0;

var homes;
var homeTime = 0;

var score = 0;
var scoreText;

//JP chaged
var gameBG1;

var invaders;
var invaderTime = 0;

var choiceText;
var choice;
//for timer
var counterText;
var delaycounter = 0;
var delaycounterText;

//for fire
var fireButton;
var firedButton;

//for time
var counterTime = 0;

//for text
var startText;
var overText;
var winText;
//for BG
var startBG;
var overBG;
var winBG;
//    restartText.anchor.setTo(0.5, 0.5); //remember to set anchor for some vars
function create() {
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    //  The scrolling gameBG1 background
    gameBG1 = game.add.tileSprite(0, 0, 667, 345, 'gameBG1');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the ground.
    var wall = platforms.create(-65, 0, 'wall');
    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    wall.scale.setTo(2, 2);
    //  This stops it from falling away when you jump on it
    wall.body.immovable = true;

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 120, 'dude');
    //scale the player 2 times bigger
    player.scale.setTo(2,2);
    //  We need to enable physics on the player
    game.physics.arcade.enable(player);
    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 800;
    player.body.collideWorldBounds = true;
    //  Our two animations, walking left and right.
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);

    //for start page
    startBG = game.add.tileSprite(0,0, 667, 345, 'startBG');
    startBG.anchor.setTo(0,0);
    
    startBG.visible = true;

    //for start page
    overBG = game.add.tileSprite(0, 0, 800, 600, 'overBG');
    overBG.anchor.setTo(0, 0);
    overBG.visible = false;

    //for start page
    winBG = game.add.tileSprite(0, 0, 800, 600, 'winBG');
    winBG.anchor.setTo(0, 0);
    winBG.visible = false;

    //  The text
    scoreText = game.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#ffffff' });

    //counterText = game.add.text(16, 48, 'Counter: 0', { fontSize: '32px', fill: '#ffffff' });

    //delaycounterText = game.add.text(16, 80, 'Choice: 0', { fontSize: '32px', fill: '#ffffff' });

    overText = game.add.text(game.world.centerX , game.world.centerY,'', { font: '84px Arial', fill: '#ffffff' });
    overText.anchor.setTo(0.5, 0.5);
    overText.visible = false;

    winText = game.add.text(game.world.centerX , game.world.centerY,'', { font: '84px Arial', fill: '#ffffff' });
    winText.anchor.setTo(0.5, 0.5);
    winText.visible = false;

    startText = game.add.text(game.world.centerX , game.world.centerY,'Click to START', { font: '84px Arial', fill: '#ffffff' });
    startText.anchor.setTo(0.5, 0);
    startText.visible = true;

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
    //mouseclick = game.input.onTap.add(tapJump, this);
    //enemy
    fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
    firedButton = game.input.keyboard.addKey(Phaser.Keyboard.S);

    //  Our star group
    stars = game.add.group();
    stars.enableBody = true;
    stars.physicsBodyType = Phaser.Physics.ARCADE;
    stars.createMultiple(30, 'flower');
    stars.setAll('anchor.x', 0.5);
    stars.setAll('anchor.y', 0.5);

    invaders = game.add.group();
    invaders.enableBody = true;
    invaders.physicsBodyType = Phaser.Physics.ARCADE;
    invaders.createMultiple(30, 'invader');
    invaders.setAll('anchor.x', 0.5);
    invaders.setAll('anchor.y', 1);

    // player.setAll('checkWorldBounds', true);
    game.input.onTap.addOnce(startBG,this);
}


function collectStars (player, stars) {
    // Removes the star from the screen
    stars.kill();
    //  Add and update the score
    score += 10;
    //updating score
    scoreText.text = 'Score: ' + score;
    //for restart
    if (score == 10){
        invaders.callAll('kill');
        winText.text = " You Won, \n Click to restart";
        winText.visible = true;
        winBG.visible = true;
        overBG.visible = false;
        overText.visible = false;
        //kill all the invaders when winning
        //the "click to restart"
        game.input.onTap.addOnce(restart,this);
    }
}

function hitinvader (player, invaders) {
    // Removes the star from the screen
    invaders.kill();
    //  Add and update the score
    // score -= 1;
    scoreText.text = 'Score: ' + score;
        //When the player dies
        //player.kill();
        stars.callAll('kill');

        overText.text=" GAME OVER \n Click to restart";
        overText.visible = true;
        overBG.visible = true;

        //the "click to restart" handler
        if (overText.visible){
            game.input.onTap.addOnce(restart,this);
        }
}

function resetStar (star, platforms) {
    //  Called if the star hit the platform (left)
    star.kill();
}

function resetInvader (invader, platforms) {
    //  Called if the invader hit the platform (left)
    invader.kill();
}

//let the invader go functions
function fireInvader(){
        if (game.time.now > invaderTime){
        //  Grab the first invader we can from the pool
        invader = invaders.getFirstExists(false);
        if (invader){
            //  And fire it
            invader.reset(game.world.width+50, game.world.height-25);
            invader.body.velocity.x = -400;
            //in case of firing too many at once
            invaderTime = game.time.now + 1000;
        }
    }
}

function fireStar(){
        if (game.time.now > starTime){
        //  Grab the first star we can from the pool
        star = stars.getFirstExists(false);

        if (star){
            //  And fire it
            star.reset(game.world.width+50, player.y+50);
            star.body.velocity.x = -400;
            //in case of firing too many at once
            starTime = game.time.now + 600;
        }
    }
}

function fireHome(){
        if (game.time.now > starTime){
        //  Grab the first star we can from the pool
        star = stars.getFirstExists(false);

        if (home){
            //  And fire it
            home.reset(game.world.width+50, player.y+25);
            home.body.velocity.x = -400;
            //in case of firing too many at once
            homeTime = game.time.now + 600;
        }
    }
}

function restart () {
    //hide the restart text
    overText.visible = false;
    winText.visible = false;
    overBG.visible = false;
    winBG.visible = false;
    score = 0;
    scoreText.text = 'Score: ' + score;
    }

function gamestart(){
    startBG.visible = false;
    startText.visible = false;
}

function update() {
    //choice randoms between 1~5
    if (game.time.now > counterTime){
        choice = Math.floor((Math.random() * 3) + 1); 
        //things comes our every 0.5 sec
        counterTime = game.time.now + 600;
    }

    if (game.input.activePointer.isDown  && player.body.blocked.down && overBG.visible == false && startBG.visible == false && winBG.visible ==false){
        player.body.velocity.y = -500;
    }
    else if (game.input.activePointer.isDown  && startBG.visible == true){
        gamestart();
    }

    //press space to jump
    if (fireButton.isDown  && player.body.blocked.down ){
        player.body.velocity.y = -500;
    }

    //  Scroll the background
    gameBG1.tilePosition.x -= 2;
    //JP changed player running right always
    player.animations.play('right');
    
    //JP allow player go down faster
    if (cursors.down.isDown && !(player.body.touching.down))
    {
        player.body.velocity.y += 5;
    }
    
    //  Checks to see if the player overlaps with stars, if he does call the collectStar function
    game.physics.arcade.overlap(player, stars, collectStars, null, this);
    //  Checks to see if the player overlaps with invader, if he does call the hitinvader function
    game.physics.arcade.overlap(player, invaders, hitinvader, null, this);

    //if star hits platform, kill it
    game.physics.arcade.overlap(stars, platforms, resetStar, null, this);

    game.physics.arcade.overlap(invaders, platforms, resetInvader, null, this);

    if ((choice == 1)){
        if (overBG.visible == false && startBG.visible == false && winBG.visible ==false){
            fireInvader();
        }
    }
    if ((choice == 2) || fireButton.isDown || firedButton.isDown){
        if (overBG.visible == false && startBG.visible == false && winBG.visible ==false){
            fireStar();
        }
    }
    if (winBG.visible == true){
        invaders.callAll('kill');
        stars.callAll('kill');
    }
    if (overBG.visible == true){
        invaders.callAll('kill');
        stars.callAll('kill');
    }
    //delaycounterText.text = 'Choice: ' + choice;
}

</script>

</body>
</html>